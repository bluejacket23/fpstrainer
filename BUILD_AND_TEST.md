# Build and Test Guide

## Quick Steps

### 1. Install Dependencies (if needed)
```bash
npm install
```

### 2. Set OpenAI API Key Secret
**IMPORTANT:** Do this before deploying the backend!

```bash
npx ampx sandbox secret set OPENAI_API_KEY
```
When prompted, paste your OpenAI API key and press Enter.

**Verify it's set:**
```bash
npx ampx sandbox secret list
```
You should see `OPENAI_API_KEY` in the list.

### 3. Deploy Backend (Terminal 1)

Start the Amplify sandbox to deploy your backend:

```bash
npx ampx sandbox
```

This will:
- Deploy all Lambda functions (upload-init, frame-extractor, ai-analysis, get-report, complete-multipart-upload)
- Create DynamoDB table for reports
- Create S3 bucket for video uploads
- Set up Cognito authentication

**Wait for it to finish!** You'll see output like:
```
✓ Sandbox environment deployed
✓ Backend deployed successfully
```

The sandbox will also start the frontend automatically. You'll see a URL like:
```
Local: http://localhost:3000
```

### 3.5. Auto-Configure Lambda Functions (After Deployment)

After the sandbox is running, configure all Lambda functions automatically:

```bash
npm run auto-config
```

This script will:
- Set all environment variables (TABLE_NAME, BUCKET_NAME, OPENAI_API_KEY, etc.)
- Configure IAM permissions for all functions
- Get resource names from `amplify_outputs.json` automatically

**Note:** Make sure you have AWS credentials configured (`aws configure`) for this to work.

### 4. Run Frontend (Terminal 2 - Optional)

If you want to run the frontend separately (or if sandbox didn't start it):

```bash
npm run dev
```

This starts the Next.js dev server at `http://localhost:3000`

### 5. Test the Application

1. **Open your browser** to `http://localhost:3000`

2. **Sign up / Log in:**
   - Create an account or log in with existing credentials
   - Cognito authentication is automatically configured

3. **Upload a video:**
   - Go to `/upload` page
   - Drag & drop or select a video file (max 60 seconds)
   - Watch the upload progress
   - Wait for processing (frame extraction + AI analysis)

4. **View reports:**
   - Go to `/dashboard` to see all your reports
   - Click on a report to view detailed analysis
   - Check the tier system and statistics

5. **Test account page:**
   - Go to `/account` to see subscription management
   - Verify pricing tiers display correctly with checkmarks

### 6. Check Logs (if something goes wrong)

**CloudWatch Logs:**
- Go to AWS Console → CloudWatch → Log groups
- Search for your Lambda function names:
  - `upload-init-lambda`
  - `frame-extractor-lambda`
  - `ai-analysis-lambda`
  - `get-report-lambda`
  - `complete-multipart-upload-lambda`

**Browser Console:**
- Open browser DevTools (F12)
- Check Console tab for frontend errors
- Check Network tab for API call failures

## Production Build

For production deployment:

### Build Frontend:
```bash
npm run build
```

### Start Production Server:
```bash
npm start
```

### Deploy to AWS Amplify:
1. Push code to GitHub
2. Connect repo to AWS Amplify Console
3. Amplify will automatically detect and deploy Gen 2 backend + frontend

## Troubleshooting

### Backend not deploying?
- Check AWS credentials: `aws configure list`
- Verify you have permissions for Lambda, S3, DynamoDB, Cognito
- Check for errors in the sandbox output

### OpenAI API errors?
- Verify secret is set: `npx ampx sandbox secret list`
- Check Lambda environment variables in AWS Console
- Verify API key is valid and has credits

### Video upload fails?
- Check S3 bucket permissions
- Verify `upload-init` Lambda has correct IAM permissions
- Check browser console for errors

### No thumbnails?
- Thumbnails are generated during frame extraction
- Check `frame-extractor` Lambda logs
- Verify S3 permissions for thumbnail storage

### Frontend not loading?
- Check `amplify_outputs.json` exists (generated by sandbox)
- Verify `ConfigureAmplify.tsx` is properly set up
- Check browser console for configuration errors

## Quick Commands Reference

```bash
# Deploy backend + start frontend
npx ampx sandbox

# Deploy backend only (one-time)
npx ampx sandbox --once

# Auto-configure all Lambda functions (after deployment)
npm run auto-config
# or
npm run config

# Set secret
npx ampx sandbox secret set OPENAI_API_KEY

# List secrets
npx ampx sandbox secret list

# Run frontend only
npm run dev

# Build frontend
npm run build

# Start production server
npm start
```

